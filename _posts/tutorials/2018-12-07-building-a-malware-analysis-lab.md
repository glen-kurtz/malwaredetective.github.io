---
layout: post
title:  "Building a Malware Analysis Lab"
date: 2018-12-07 16:39:58 -0600
categories: tutorials
tags: [malware, tutorials]
permalink: "/tutorials/building-a-malware-analysis-lab.html"
summary: "A simple walkthrough guiding you through the process of setting up your own Malware Analysis Lab."
---
A Malware Analysis Lab is your solution to performing analysis in a safe environment, without fear of impacting your existing infrastructure. It's an essential component within an Information Security Analysts toolkit and something that you'll rely on time and time again throughout your endeavors. There are multiple circumstances that could prompt you to solicit the services from your Malware Analysis Lab. Some common use cases include:
* Analyzing something to identify whether or not it's malicious.
* Analyzing known malicious code to capture IOC/Behavioral indicators.
* Analyzing known malicious code to see how your security tool stack responds.

## Configuration
To start, let's review the basic components of our Malware Analysis Lab.
1. Virtual Target(s)
    - A virtual target is the system that well be utilizing to perform analysis on malicious code. *You may want to setup multiple virtual targets depending on your use case.*
2. Controller
    - A controller is the system that well be utilizing to configure additional monitoring on our virtual target. By routing the network traffic from our virtual target through our controller before reaching the internet, we can take advantage of some packet monitoring software to improve our visibility.

![Malware Analysis Lab - Diagram](/assets/img/malware_analysis_lab.jpg)

You can setup your Malware Analysis Lab using a combination of physical and virtual machines. For instance, you could setup your controller on a physical machine, then install virtualization software so that you can spin up virtual targets directly on your controller. I'll be using [Virtual Box](https://www.virtualbox.org/) to power my virtual machines. In addition to being Open Source, Virtual Box includes snapshotting, which is a must-have feature for our Malware Analysis Lab. Snapshotting will allow us to save the current state of our virtual machine. This allows us to revert our virtual machine back to a clean image after we've infected it, restoring all of the software we installed and any personalized configuration settings we previously made.

### Setting up your Controller
* Create a controller using your preferred flavor of Linux. In this walkthrough, I'll be using the latest version of Ubuntu Server, with a Gnome desktop.
* If your controller is running from a virtual machine, make sure to utilize a **Bridged** Network Adapter. 
* Configure your network interface to utilize a static IP Address.
* Configure your controller to forward network traffic.
    - Enable IP forwarding by modifying the **/etc/sysctl.conf** file:
    ```
    sudo nano /etc/sysctl.conf
    ```
    - Add a line containing *net.ipv4.ip_forward=1* to enable IP forwarding. Alternatively, if this command is already included within your **/etc/sysctl.conf** file and commented out, then you can simply uncomment it.
    - Run this command to enable the changes you made to **/etc/sysctl.conf** immediately: 
    ```
    sysctl -p /etc/sysctl.conf
    ```
    - Update the default firewall policy to forward packets:
    ```
    sudo iptables -P FORWARD ACCEPT
    ```
* Install additional software to improve our network monitoring capabilities:
    - [Snort](https://www.snort.org/) is an open source Intrusion Detection System capable of real-time traffic analysis and packet logging. We can use Snort to identify if our malware triggers any common IDS signatures.
    ```
    sudo apt-get install snort
    sudo snort -c snort.conf -A full
    ```
    - [Wireshark](https://www.wireshark.org/) is a network protocol analyzer that we can utilize to capture and analyze the traffic coming from our virtual target. 
    ```
    sudo apt-get install wireshark
    ```

### Setting up your Virtual Target
* Create a Virtual Machine using your preferred version of Windows.
* Modify the network settings within your virtualization software to utilize a **Bridged** Network Adapter. 
* Make sure to avoid using any Personally Identifiable Information when naming your virtual target and setting up your user account. It's common for malware to send basic system information back to the attackers.
* Configure your network interface to utilize your controller as the Default Gateway. This way, any traffic from our virtual target will be routed through our controller.
* Ensure that any Network Shares and Removable Media connected to your virtual target are in Read-Only mode. 
* Install any additional software that you might need to utilize for malware analysis:
    - [Burp](https://portswigger.net/burp) is a GUI tool for testing web application security. We can utilize the community edition of Burp to intercept and modify HTTP traffic. 
    - [ExifTool](http://owl.phy.queensu.ca/~phil/exiftool/) can be used to parse metadata from a wide variety of different file formats. ExifTool is a simple way to gather additional data from a file.
    - [Microsoft Sysinternals Suite](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite) is a collection of utilities designed to monitor, manage, and troubleshoot the Windows operating system. This suite includes numerous gems that enhance our malware analysis capabilities including Autoruns, ProcMon, and Strings.
    - [OllyDbg](http://www.ollydbg.de/version2.html) is an x86 debugger for Microsoft Windows. OllyDbg can be used to Reverse Engineer software when the source code is unavailable.
    - [PEiD](https://www.softpedia.com/get/Programming/Packers-Crypters-Protectors/PEiD-updated.shtml) is a GUI tool for Windows that can be used to detect packers, cryptors, and compilers for PE files.
    - [Volatility](https://www.volatilityfoundation.org/26) is an open source memory forensics framework for incident response and malware analysis.
    - [Wireshark](https://www.wireshark.org/) is a network protocol analyzer that we can utilize to capture and analyze the traffic coming from our virtual target. Although we already configured Wireshark on our controller. Sometimes it's useful to capture and analyze packets directly on our virtual target when we don't want to swap between hosts.
* Create a snapshot once you've finished configuring your virtual target. To create a snapshot in VirtualBox -> Log into your virtual target and use **<Right-Ctrl + T>** to open the snapshot dialog box -> Name your snapshot and select **OK**.

## Operation
Now that you've configured a safe lab environment, you're ready to perform some malware analysis! After you've finished analyzing a sample, you can reset your virtual target back to it's default state by launching Oracle VM VirtualBox Manager -> Selecting your Virtual Target -> Select **Settings** -> Select **Snapshots** -> Select your Snapshot -> Select **Restore**. In future tutorials, I'll cover the difference between dynamic and static malware analysis, as well as go through some common analysis techniques to get you started. 

![VirtualBox - Snapshots](/assets/img/virtualbox_snapshots_properties.png)