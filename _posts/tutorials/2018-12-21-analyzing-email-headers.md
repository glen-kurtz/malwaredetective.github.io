---
layout: post
title:  "Analyzing Email Headers"
date: 2018-12-07 16:39:58 -0600
categories: tutorials
tags: [phishing, tutorials]
permalink: "/tutorials/analyzing-email-headers.html"
summary: "The fundamental principles of email header analysis."
---
An email consists of three components; the envelope, the body, and the header(s). The envelope is used for internal process and routing. The body is the actual content within the email. The header contains meta-data such as Date, To, From, User Agent, IP Address of the Sender/Receiver. The information embedded within an email header can help us determine whether or not an email was spoofed.

## How to Analyze an Email Header
* Retrieve an original copy of the email you'd like to analyze. The email headers within a message are unique to that particular message. As a result, you will need to analyze the original copy of the email in order to view the original email headers.
* Open the email in Outlook -> Select **File** -> Select **Properties** -> Use **\<Ctrl + A\>** to highlight all of the contents within the Internet Headers message box and **\<Ctrl + C\>** to copy the contents. (*The process for viewing the headers will vary depending on the mail client that you're utilizing.*)

![Email Header Properties](/assets/img/email_header_properties.png)

* Open up a web browser and navigate to: [https://mxtoolbox.com/emailheaders.aspx](https://mxtoolbox.com/emailheaders.aspx).
* Paste your email header within the message box and select **Analyze Header**. MXToolbox is a free online utility that will automatically parse out your email header to simplify analysis.

## Analyzing Email Headers
Email is still one of the simplest and most prevalent threat vectors exploited by attackers. As a result, having the expertise to analyze an email header is an essential skill for any security analyst.

### Analyzing Relay Information
The path an email takes in transit can help you identify its origin. In the example below, you can see that an email originated from **sendgrid.net** then passed through **humblebundle.com** then finally made its way to my instance of **Office 365**. (*Keep in mind that data listed in any mail servers outside of your organization could've been spoofed.*)

![Email Header Properties](/assets/img/email_relay.png)

Knowing what's *normal* in regards to mail flow within your environment will help you add context to the email relay your investigating. Here's the typical mail flow for an organization using **Office 365** as their mail client and **MailScanner** as their mail filter.

| **Mail Flow** | **Relay Information** |
| --- | --- |
| Internal **->** Internal | O365 **->** O365 |
| Internal **->** External | O365 **->** MailScanner **->** External Email Server |
| External **->** Internal | External Email Server **->** MailScanner **->** O365 |

### Analyzing Email Headers
Email headers are structed using Key/Value pairs. MXToolbox will automatically parse these Key/Value pairs and output them into an easily digestible format. The email headers at your disposal may vary email to email. This is because only a limited number of headers are actually required. Fortunately for us additional headers are usually attended by the Mail User Agent (MUA) transmitting the email.

| **Header Name** | **Header Value** |
| --- | --- |
| Date | Specifies the date and time at which the creator of the message indicated that the message was complete and ready to enter the mail delivery system. |
| From | Specifies the author of the message. |
| To | Contains the address(es) of the primary recipient(s) of the message. |
| Reply-To | When the "Reply-To:" field is present, it indicates the mailbox(es) to which the author of the message suggests that replies be sent. Attackers will often utilize this field so that they can receive a reply after spoofing messages. |
| Subject | Contains a short string identifying the topic of the message. |
| Message-ID | Contains a single unique message identifier that refers to a particular version of a particular message. |
| References | The message identifier(s) of other message(s) to which the current message may be related. |
| User-Agent | Consists of one or more product identifiers. |
| X-Authenticated-Sender | Shows the logged in user who sent the message through the mail client. |
| X-Mailer | Describes the mail client that was used to send the message. |
| X-Originating-IP | Identifies the originating IP address of a client connecting to a mail services HTTP frontend. |